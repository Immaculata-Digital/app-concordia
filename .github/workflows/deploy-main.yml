name: Build and Deploy - APP Concordia Main

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_and_push:
    name: Build & Push Image to GHCR
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: app-concordia

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build imagem
        run: |
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          docker build \
            --build-arg VITE_API_USUARIOS_URL='${{ secrets.VITE_API_USUARIOS_URL_MAIN }}' \
            --build-arg VITE_API_CLIENTES_URL='${{ secrets.VITE_API_CLIENTES_URL_MAIN }}' \
            --build-arg VITE_API_COMUNICACOES_URL='${{ secrets.VITE_API_COMUNICACOES_URL_MAIN }}' \
            --build-arg VITE_API_CONTRATOS_URL='${{ secrets.VITE_API_CONTRATOS_URL_MAIN }}' \
            --build-arg VITE_API_PESSOAS_URL='${{ secrets.VITE_API_PESSOAS_URL_MAIN }}' \
            --build-arg VITE_API_CONTATOS_URL='${{ secrets.VITE_API_CONTATOS_URL_MAIN }}' \
            --build-arg VITE_API_RELATORIOS_URL='${{ secrets.VITE_API_RELATORIOS_URL_MAIN }}' \
            --build-arg VITE_WS_SERVICE_URL='${{ secrets.VITE_WS_SERVICE_URL_MAIN }}' \
            -t ghcr.io/${REPO_OWNER_LOWER}/${IMAGE_NAME}:latest .

      - name: Push imagem
        run: |
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          docker push ghcr.io/${REPO_OWNER_LOWER}/${IMAGE_NAME}:latest

  deploy:
    name: Pull & Run on Server
    runs-on: self-hosted
    needs: build_and_push

    env:
      IMAGE_NAME: app-concordia

    steps:
      - name: Login GHCR (no servidor)
        run: |
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${REPO_OWNER_LOWER} --password-stdin

      - name: Pull da nova imagem
        run: |
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          docker pull ghcr.io/${REPO_OWNER_LOWER}/${IMAGE_NAME}:latest

      - name: Parar e remover container antigo
        run: |
          docker stop ${IMAGE_NAME}-main || true
          docker rm ${IMAGE_NAME}-main || true

      - name: Subir container novo
        run: |
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          docker run -d \
            --name ${IMAGE_NAME}-main \
            --restart unless-stopped \
            -p 3175:80 \
            -e VITE_API_USUARIOS_URL='${{ secrets.VITE_API_USUARIOS_URL_MAIN }}' \
            -e VITE_API_CLIENTES_URL='${{ secrets.VITE_API_CLIENTES_URL_MAIN }}' \
            -e VITE_API_COMUNICACOES_URL='${{ secrets.VITE_API_COMUNICACOES_URL_MAIN }}' \
            -e VITE_API_CONTRATOS_URL='${{ secrets.VITE_API_CONTRATOS_URL_MAIN }}' \
            -e VITE_API_PESSOAS_URL='${{ secrets.VITE_API_PESSOAS_URL_MAIN }}' \
            -e VITE_API_CONTATOS_URL='${{ secrets.VITE_API_CONTATOS_URL_MAIN }}' \
            -e VITE_API_RELATORIOS_URL='${{ secrets.VITE_API_RELATORIOS_URL_MAIN }}' \
            -e VITE_WS_SERVICE_URL='${{ secrets.VITE_WS_SERVICE_URL_MAIN }}' \
            ghcr.io/${REPO_OWNER_LOWER}/${IMAGE_NAME}:latest

      - name: Limpeza de imagens antigas
        run: |
          docker image prune -f || true
